<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entraînement Apnée</title>
    <style>
        :root {
            --primary: #6C5B7B;
            --secondary: #355C7D;
            --background: #F8B195;
            --text: #2A363B;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background);
            color: var(--text);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #fff;
            border: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            color: black;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .breath-circle {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            transition: all 0.5s ease-in-out;
        }

        .hyperventilation {
            background: #6C5B7B;
            border-radius: 50%;
        }

        .empty {
            background: #355C7D;
            border-radius: 10%;
        }

        .full {
            background: #F8B195;
            border-radius: 30%;
        }

        .timer {
            font-size: 3em;
            text-align: center;
            margin: 20px 0;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        .round-config {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        input[type="number"] {
            padding: 5px;
            margin: 5px;
            width: 80px;
        }

        .stats-list {
            list-style: none;
            padding: 0;
        }

        .stats-list li {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 5px;
        }

        @media (max-width: 600px) {
            .breath-circle {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showSection('program')">Programmer</button>
            <button class="tab" onclick="showSection('practice')">Pratiquer</button>
            <button class="tab" onclick="showSection('stats')">Statistiques</button>
        </div>

<div id="program" class="section active">
     <h2>Configuration de la session</h2>
     <div>
        <label>Hyperventilation:</label><br>
        <label>- Nombre de respirations:</label>
        <input type="number" id="breathCount" min="1"><br>
        <label>- Vitesse (resp/min):</label>
        <input type="number" id="breathSpeed" min="10"><br><br>
        <label>Temps apnée plein:</label>
        <input type="number" id="fullTime" min="10">
    </div>
    
    <h3>Rounds</h3>
    <div id="roundsContainer"></div>
    <button onclick="addRound(); saveConfig()">Ajouter Round</button>
    <br><br><button onclick="exportConfig()">Exporter la configuration</button>
    <input type="file" id="importConfigInput" accept=".json" style="display: none;" onchange="importConfig(event)">
    <button onclick="document.getElementById('importConfigInput').click()">Importer la configuration</button>
</div>

<div id="practice" class="section">
    <div class="breath-circle hyperventilation"></div>
    <div class="timer" id="counter">-</div>
    <div id="roundInfo" style="text-align: center; font-size: 1.2em; margin-bottom: 10px;">-</div>
    <div id="easyCheckbox" style="display: none; text-align: center;">
        <input type="checkbox" id="tooEasy">
        <label for="tooEasy">Apnée vide trop facile</label>
    </div>
    <button id="startBtn" onclick="startSession()">Commencer</button>
    <button id="stopBtn" style="display: none; background: #e74c3c;" onclick="stopSession()">Arrêter la session</button>
</div>


        <div id="stats" class="section">
            <h2>Historique des performances</h2>
            <ul class="stats-list" id="statsList"></ul>
            <button onclick="exportStats()">Exporter en Markdown</button>
            <button onclick="clearStats()">Effacer l'historique</button>
        </div>
    </div>

    <script>
        let currentSession = [];
        let currentRound = 0;
        let audioContext;
        let isPracticing = false;
        let stopRequested = false;
        let appConfig = {
            breathCount: 30,
            breathSpeed: 30,
            fullTime: 60,
            rounds: []
        };

        function initialize() {
            loadConfig();
            loadStats();
            document.getElementById('breathCount').addEventListener('change', saveConfig);
            document.getElementById('breathSpeed').addEventListener('change', saveConfig);
            document.getElementById('fullTime').addEventListener('change', saveConfig);
        }

        function updateRoundInfo(roundIndex, emptyTime) {
            const roundInfo = document.getElementById('roundInfo');
            roundInfo.textContent = `Round ${roundIndex + 1} - Apnée vide: ${emptyTime === 'infinite' ? 'infini' : `${emptyTime}s`}`;
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }
        function exportConfig() {
            // Préparer les données de configuration actuelles
            const configData = JSON.stringify(appConfig, null, 2); // Formatage lisible avec indentation
            
            // Créer un fichier Blob JSON
            const blob = new Blob([configData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Créer un lien temporaire pour le téléchargement
            const a = document.createElement('a');
            a.href = url;
            a.download = 'apnea_config.json'; // Nom du fichier
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Charger le contenu du fichier JSON
                    const importedConfig = JSON.parse(e.target.result);
                    
                    // Valider la structure (optionnel, pour éviter des erreurs)
                    if (!importedConfig.breathCount || !importedConfig.breathSpeed || !importedConfig.fullTime || !importedConfig.rounds) {
                        alert("Le fichier JSON n'a pas une structure valide pour la configuration.");
                        return;
                    }
                    
                    // Mettre à jour appConfig avec les données importées
                    appConfig = importedConfig;
                    
                    // Sauvegarder dans localStorage
                    localStorage.setItem('apneaConfig', JSON.stringify(appConfig));
                    
                    // Recharger l'interface avec la nouvelle configuration
                    loadConfig();
                    
                    alert("Configuration importée avec succès !");
                } catch (error) {
                    alert("Erreur lors de l'importation : fichier invalide ou corrompu.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Réinitialiser l'input pour permettre une nouvelle importation
            event.target.value = '';
        }

        function addRound(emptyTime = 60, isInfinite = false, tooEasy = false, isActive = true) {
            const div = document.createElement('div');
            div.className = 'round-config';
            div.innerHTML = `
                <label>Actif:</label>
                <input type="checkbox" class="roundActive" ${isActive ? 'checked' : ''}>
                Round ${document.querySelectorAll('.round-config').length + 1}
                <label>Temps apnée vide:</label>
                <input type="number" class="emptyTime" min="10" value="${emptyTime}" ${isInfinite ? 'disabled' : ''}>
                <label>Infini:</label>
                <input type="checkbox" class="infiniteEmpty" ${isInfinite ? 'checked' : ''}>
                <label>Trop facile:</label>
                <input type="checkbox" class="tooEasy" ${tooEasy ? 'checked' : ''}>
                <button onclick="this.parentElement.remove(); saveConfig()">Supprimer</button>
            `;
            div.querySelector('.emptyTime').addEventListener('change', saveConfig);
            div.querySelector('.infiniteEmpty').addEventListener('change', function() {
                div.querySelector('.emptyTime').disabled = this.checked;
                saveConfig();
            });
            div.querySelector('.tooEasy').addEventListener('change', saveConfig);
            div.querySelector('.roundActive').addEventListener('change', saveConfig); // Écouteur pour la case "Actif"
            document.getElementById('roundsContainer').appendChild(div);
            saveConfig();
        }

       function saveConfig() {
            appConfig.breathCount = parseInt(document.getElementById('breathCount').value);
            appConfig.breathSpeed = parseInt(document.getElementById('breathSpeed').value);
            appConfig.fullTime = parseInt(document.getElementById('fullTime').value);
            appConfig.rounds = Array.from(document.querySelectorAll('.round-config')).map(round => ({
                emptyTime: round.querySelector('.infiniteEmpty').checked ? 'infinite' : parseInt(round.querySelector('.emptyTime').value),
                isInfinite: round.querySelector('.infiniteEmpty').checked,
                tooEasy: round.querySelector('.tooEasy').checked,
                isActive: round.querySelector('.roundActive').checked // Nouvel état "actif"
            }));
            localStorage.setItem('apneaConfig', JSON.stringify(appConfig));
        }

        function loadConfig() {
            const saved = localStorage.getItem('apneaConfig');
            if (saved) {
                appConfig = JSON.parse(saved);
                document.getElementById('breathCount').value = appConfig.breathCount;
                document.getElementById('breathSpeed').value = appConfig.breathSpeed;
                document.getElementById('fullTime').value = appConfig.fullTime;
                
                document.getElementById('roundsContainer').innerHTML = '';
                appConfig.rounds.forEach(round => 
                    addRound(
                        round.isInfinite ? 60 : round.emptyTime, 
                        round.isInfinite, 
                        round.tooEasy,
                        round.isActive // Charger l’état "actif"
                    )
                );
            } else {
                document.getElementById('breathCount').value = appConfig.breathCount;
                document.getElementById('breathSpeed').value = appConfig.breathSpeed;
                document.getElementById('fullTime').value = appConfig.fullTime;
                addRound();
            }
        }

async function startSession() {
    if (isPracticing) return;
    isPracticing = true;
    stopRequested = false; // Réinitialiser au début
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Cacher "Commencer" et afficher "Arrêter"
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'block';
    
    const breathCount = parseInt(document.getElementById('breathCount').value);
    const breathSpeed = parseInt(document.getElementById('breathSpeed').value);
    const breathDuration = 60 / breathSpeed * 1000;

    currentSession = Array.from(document.querySelectorAll('.round-config')).map(round => ({
        emptyTime: round.querySelector('.infiniteEmpty').checked ? 'infinite' : parseInt(round.querySelector('.emptyTime').value),
        fullTime: appConfig.fullTime,
        isInfinite: round.querySelector('.infiniteEmpty').checked
    }));

    for (currentRound = 0; currentRound < currentSession.length && !stopRequested; currentRound++) {
        await prepareRound();
        if (stopRequested) break;
        updateRoundInfo(currentRound, currentSession[currentRound].emptyTime);
        await doHyperventilation(breathCount, breathDuration);
        if (stopRequested) break;
        updateRoundInfo(currentRound, currentSession[currentRound].emptyTime);
        await doEmptyLungs(currentSession[currentRound]);
        if (stopRequested) break;
        updateRoundInfo(currentRound, currentSession[currentRound].emptyTime);
        await doFullLungs(currentSession[currentRound].fullTime, currentSession[currentRound]);
    }
    
    // Sauvegarder les stats même si interrompu
    saveStats();
    playEndSessionSound(); // Jouer la mélodie même en cas d'arrêt
    isPracticing = false;
    document.getElementById('roundInfo').textContent = '-';
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('stopBtn').style.display = 'none';
}

function stopSession() {
    stopRequested = true;
}
        function playEndSessionSound() {
            const notes = [440, 523.25, 659.25, 880]; // Mélodie simple : A4, C5, E5, B5
            let time = audioContext.currentTime;
            
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                gainNode.gain.setValueAtTime(0.5, time + index * 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + index * 0.2 + 0.15);
                
                oscillator.start(time + index * 0.2);
                oscillator.stop(time + index * 0.2 + 0.15);
            });
        }

        async function prepareRound() {
            const counter = document.getElementById('counter');
            for (let i = 3; i > 0; i--) {
                counter.textContent = i;
                playSound(550, 0.1);
                await new Promise(r => setTimeout(r, 1000));
            }
        }

async function doHyperventilation(count, duration) {
    const circle = document.querySelector('.breath-circle');
    const counter = document.getElementById('counter');
    circle.className = 'breath-circle hyperventilation';
    
    for (let i = count; i > 0 && !stopRequested; i--) {
        counter.textContent = i;
        circle.style.transform = 'scale(1.2)';
        playSound(440);
        if (i === 2) playSound(880, 0.2);
        await new Promise(r => setTimeout(r, duration / 2));
        
        circle.style.transform = 'scale(1)';
        playSound(330);
        await new Promise(r => setTimeout(r, duration / 2));
        
        if (i === 1) playSound(660, 0.5);
    }
}

async function doEmptyLungs(round) {
    const circle = document.querySelector('.breath-circle');
    const counter = document.getElementById('counter');
    circle.className = 'breath-circle empty';
    
    if (round.isInfinite) {
        let time = 0;
        counter.textContent = time;
        const interval = setInterval(() => {
            if (stopRequested) clearInterval(interval);
            else {
                time++;
                counter.textContent = time;
            }
        }, 1000);
        
        await new Promise(resolve => {
            document.addEventListener('click', function stopInfinite() {
                clearInterval(interval);
                document.removeEventListener('click', stopInfinite);
                resolve();
            });
        });
        round.emptyTime = time;
    } else {
        return new Promise(resolve => {
            let remaining = round.emptyTime;
            counter.textContent = remaining;
            const interval = setInterval(() => {
                if (stopRequested) {
                    clearInterval(interval);
                    resolve();
                } else if (remaining-- <= 0) {
                    clearInterval(interval);
                    playSound(660);
                    resolve();
                }
                counter.textContent = remaining;
            }, 1000);
        });
    }
}

async function doFullLungs(time, round) {
    const circle = document.querySelector('.breath-circle');
    const counter = document.getElementById('counter');
    const easyCheckbox = document.getElementById('easyCheckbox');
    easyCheckbox.style.display = 'block';
    document.getElementById('tooEasy').checked = false;
    
    circle.className = 'breath-circle full';
    
    return new Promise(resolve => {
        let remaining = time;
        counter.textContent = remaining;
        const interval = setInterval(() => {
            if (stopRequested) {
                clearInterval(interval);
                easyCheckbox.style.display = 'none';
                resolve();
            } else if (remaining-- <= 0) {
                clearInterval(interval);
                playSound(660);
                round.tooEasy = document.getElementById('tooEasy').checked;
                easyCheckbox.style.display = 'none';
                resolve();
            }
            counter.textContent = remaining;
        }, 1000);
    });
}

        function playSound(freq, duration = 0.1) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.stop(audioContext.currentTime + duration);
        }

      function saveStats() {
            let stats = JSON.parse(localStorage.getItem('apneaStats') || '[]');
            if (!currentSession || currentSession.length === 0) {
                console.error("currentSession est vide ou non défini");
                return;
            }
            const sessionData = {
                date: new Date().toISOString(),
                rounds: currentSession.map(round => ({
                    emptyTime: round.emptyTime !== undefined ? round.emptyTime : 0,
                    tooEasy: round.tooEasy || false
                    // fullTime est intentionnellement omis ici
                }))
            };
            stats.push(sessionData);
            localStorage.setItem('apneaStats', JSON.stringify(stats));
            
            appConfig.rounds = currentSession.map(round => ({
                emptyTime: round.isInfinite ? 'infinite' : (round.emptyTime !== undefined ? round.emptyTime : 60),
                isInfinite: round.isInfinite || false,
                tooEasy: round.tooEasy || false
            }));
            localStorage.setItem('apneaConfig', JSON.stringify(appConfig));
            loadStats();
        }
        function loadStats() {
            const stats = JSON.parse(localStorage.getItem('apneaStats') || '[]');
            const list = document.getElementById('statsList');
            list.innerHTML = stats.reverse().map(stat => `
                <li>
                    ${new Date(stat.date).toLocaleDateString()} - 
                    ${stat.rounds.length} rounds<br>
                    ${stat.rounds.map((r, i) => `
                        - Round ${i + 1}: Apnée vide: ${r.emptyTime}s ${r.tooEasy ? '(trop facile)' : ''}
                    `).join('<br>')}
                </li>
            `).join('');
        }

       function exportStats() {
            const stats = JSON.parse(localStorage.getItem('apneaStats') || '[]');
            if (stats.length === 0) {
                alert("Aucune statistique à exporter.");
                return;
            }
            let markdown = '# Historique des performances\n\n';
            stats.forEach(stat => {
                markdown += `## ${new Date(stat.date).toLocaleDateString()}\n`;
                stat.rounds.forEach((round, index) => {
                    markdown += `- Round ${index + 1}:\n`;
                    markdown += `  - Apnée vide: ${round.emptyTime}s ${round.tooEasy ? '(trop facile)' : ''}\n`;
                    // fullTime est omis ici
                });
                markdown += '\n';
            });
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'apnee_stats.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearStats() {
            localStorage.removeItem('apneaStats');
            loadStats();
        }

        initialize();
    </script>
</body>
</html>
